var React 	= require('react');
var _ = require('lodash');
var traverse = require('traverse');

//takes node and edge data and out node and edge svgs

var info = require('debug')("graph-view - info");

var Cola = require('graph-view/webcola-adaptor')();
var Node 		= require('graph-view/node-ui');
var Edge 		= require('graph-view/edge-ui');

module.exports = React.createClass({

	getInitialState: function (options) {
		var predicates = this.props.predicates || []; //
		var	entities = this.props.entities;
		var edges = [];

		entities.forEach(function (entity, i) { entity.index = i });

		//compute links

		var makeEdge = function (subj, pred, obj, entities) {
			info('makeEdge:', { subj:subj, pred: pred, obj:obj, entities:entities })
			return {
				source: subj.index,
				target: obj.index,
				type: pred,
				id: subj.id + '-' + pred + '-' + obj.id
			}
		}


		for (var i=0;i<entities.length;i++) {
			var entity = entities[i];
			for(var j=0;j<predicates.length;j++) {
				var predicate = predicates[j];
				var object = entity[predicate];
				if(typeof object !== 'undefined' && object !== null) {
					if (typeof object === 'object' && object !== null) {
						traverse(object).forEach(function (x) {
							var target = _.find(entities, { id: x });
							entities.push(makeEdge(entity, predicate, target, entities));
						})
					} else {
						var target = _.find(entities, { id: object });
						entities.push(makeEdge(entity, predicate, target, entities));
					}
				}
			}
		}

		var width 	= 400,
				height 	= 400;

		var cola = Cola
			.size([width, height])
			.avoidOverlaps(true)
			.nodes(entities)
			.links(edges)

		return {
			width: width,
			height: height,
			cola: cola,
			nodes: cola.nodes()
		}
	},


	render: function () {

		var nodes = this.state.nodes;
		var edges = this.state.cola.links();
		var actions = this.props.actions;


		return(
			React.createElement("div", null, 
				React.createElement("svg", 
					{
						width: this.state.width, 
						height: this.state.height 
					}, 
					React.createElement("g", {className: "node-group"}, 
						nodes.map(function (node) {
							return React.createElement(Node, {datum: node, actions: actions, key: node.id})
						})
					), 
					React.createElement("g", {className: "edge-group"}, 
						edges.map(function (edge) {
							return React.createElement(Edge, {datum: edge, actions: actions, key: edge.id})
						})
					)
				)
			)
		);
	},

	componentDidMount: function () {
		//tick listener triggers setState, triggers rerender
		this.state.cola.on('tick', function () {
			this.setState({ nodes: this.state.cola.nodes() })
		}.bind(this));

		//trigger force graph
		this.state.cola.start();
	},


	shouldComponentUpdate: function (nextProps, nextState) {
		//TODO use immutable.js
		//Test if new data recieved, if true rerender
		// if (nextProps.nodes === this.props.nodes 
		// 		|| nextProps.edges === this.props.edges) return false;
		// else return true;
		return true;
	},

	componentWillUpdate: function (nextProps, nextState) {




	},





})

